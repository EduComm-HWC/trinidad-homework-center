# Faith Tabernacle Homework Center - Vercel Deployment Configuration

version: 2
builds:
  .env:
    env:
      DATABASE_URL: '@database_url'
      NEXT_PUBLIC_APP_URL: '@app_url'
      NEXTAUTH_SECRET: '@nextauth_secret'
      JITSI_BASE_URL: '@jitsi_base_url'
      JITSI_APP_ID: '@jitsi_app_id'
      JITSI_APP_SECRET: '@jitsi_app_secret'
    preview:
      env:
        DATABASE_URL: '@database_url_preview'
        NEXT_PUBLIC_APP_URL: '@app_url_preview'
        NEXTAUTH_SECRET: '@nextauth_secret_preview'
        JITSI_BASE_URL: '@jitsi_base_url'
        JITSI_APP_ID: '@jitsi_app_id'
        JITSI_APP_SECRET: '@jitsi_app_secret'

framework: nextjs
regions:
  - iad1
  - sfo1

functions:
  api/sea-test-generator:
    maxDuration: 30
  api/csec-test-generator:
    maxDuration: 30
  api/ai-recommendations:
    maxDuration: 30
  api/video-conferencing:
    maxDuration: 30
  api/analytics:
    maxDuration: 30
  api/test-db:
    maxDuration: 30

rewrites:
  - source: /api/(.*)
    destination: /api/$1

headers:
  - source: /(.*) 
    headers:
      - Cache-Control: 'public, max-age=31536000, must-revalidate'
      - X-Content-Type-Options: 'nosniff'
      - X-Frame-Options: 'DENY'
      - X-XSS-Protection: '1; mode=block'
      - Referrer-Policy: 'strict-origin-when-cross-origin'

env:
  NODE_ENV: production
  NEXTAUTH_URL: '@nextauth_url'
  NEXTAUTH_SECRET: '@nextauth_secret'
  DATABASE_URL: '@database_url'
  NEXT_PUBLIC_APP_URL: '@app_url'
  JITSI_BASE_URL: '@jitsi_base_url'
  JITSI_APP_ID: '@jitsi_app_id'
  JITSI_APP_SECRET: '@jitsi_app_secret'

# Build Configuration
buildCommand: 'next build && cp -r .next/static .next/standalone/.next/ && cp -r public .next/standalone/'
outputDirectory: '.next'
installCommand: 'npm install'
devCommand: 'next dev -p 3000 2>&1 | tee dev.log'
startCommand: 'NODE_ENV=production bun .next/standalone/server.js 2>&1 | tee server.log'

# Security Headers
security:
  headers:
    - X-Frame-Options: 'DENY'
    - X-Content-Type-Options: 'nosniff'
    - X-XSS-Protection: '1; mode=block'
    - Referrer-Policy: 'strict-origin-when-cross-origin'
    - Permissions-Policy: 'interest-rate=1'

# Caching Strategy
caching:
  maxAge: 31536000  # 1 year
  staleWhileRevalidate: true

# Rate Limiting
rateLimit:
  api:
    windowMs: 15000
    maxRequests: 100
  skipSuccessfulRequests: false